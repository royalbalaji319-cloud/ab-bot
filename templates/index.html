<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Chatbot</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>

  <body>
    <!-- HEADER -->
<div class="chat-header">
  <div class="bot-profile">
    <img src="https://cdn.pixabay.com/photo/2023/10/27/18/28/ai-generated-8345978_1280.jpg" alt="AB Bot">
    <div class="bot-info">
      <h3>AB Bot</h3>
      <span>Online</span>
    </div>
  </div>
</div>

<!-- CHAT AREA -->
<div class="chat-container">
    <div class="chat-box" id="chatBox"></div>
</div>
      <!-- âœ… ONLY ONE TYPING BAR -->
      <div class="typing" id="typing">
        AI is typing...
        <button id="stopBtn">Stop</button>
      </div>

      <div class="input-box">
        <input
          type="text"
          id="userInput"
          placeholder="Ask anything..."
          onkeydown="if (event.key === 'Enter') sendMessage();"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      let stopRequested = false;
      let typingTimer = null;

      const typingEl = document.getElementById("typing");
      const chatBox = document.getElementById("chatBox");
      const stopBtn = document.getElementById("stopBtn");

      typingEl.style.display = "none"; // âœ… page load safe

      async function sendMessage() {
        const input = document.getElementById("userInput");
        const message = input.value.trim();
        if (!message) return;

        chatBox.innerHTML += `
    <div class="row user-row">
      <div class="user-msg">${escapeHtml(message)}</div>
    </div>
  `;
        autoScroll();
        input.value = "";

        stopRequested = false;
        typingEl.style.display = "flex";

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        const data = await res.json();
        typingEl.style.display = "none";

        const row = document.createElement("div");
        row.className = "row bot-row";

        const botBox = document.createElement("div");
        botBox.className = "bot-msg";
        row.appendChild(botBox);
        chatBox.appendChild(row);

        autoScroll();
        typeHTML(botBox, formatText(data.reply), 15);
      }

      /* âœ… TYPING EFFECT */
      function typeHTML(el, html, speed) {
        let i = 0;
        el.innerHTML = "";

        function run() {
          if (stopRequested) return;
          el.innerHTML = html.slice(0, i);
          autoScroll();
          if (i < html.length) {
            i++;
            typingTimer = setTimeout(run, speed);
          }
        }
        run();
      }

      /* ðŸ›‘ STOP BUTTON */
      stopBtn.onclick = () => {
        stopRequested = true;
        clearTimeout(typingTimer);
        typingEl.style.display = "none";
      };

      /* FORMAT */
      function formatText(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
          .replace(/^\*\s+/gm, "â€¢ ")
          .replace(/\n/g, "<br>");
      }

      function autoScroll() {
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function escapeHtml(text) {
        return text.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[m],
        );
      }
    </script>
  </body>
</html>
